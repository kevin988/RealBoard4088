# 简介 #

2_mtd_nand 是一个针对MTD NAND设备的基本例程，包含基本的内核，命令行程序，以及注册一个MTD NAND设备。

在RealBoard LPC4088开发板上有一颗128MB的HY27UF081G NAND Flash，它位于核心板上。

HY27UF081G的驱动放在drivers\drv_hy27uf081g.h drivers\drv_hy27uf081g.c文件中。

## 配置说明 ##

`rtconfig.h` 文件中包括这个例子的配置信息，主要是定义了：

    // <bool name="RT_USING_MTD_NAND" description="Using MTD nand driver framework" default="true" />
    #define RT_USING_MTD_NAND
    // <bool name="RT_MTD_NAND_DEBUG" description="Enable MTD nand debug" default="false" />
    #define RT_MTD_NAND_DEBUG

其中 `RT_USING_MTD_NAND` 定义了系统需要支持MTD_NAND类型的设备；而 `RT_MTD_NAND_DEBUG` 则打开了MTD_NAND设备中的调试功能。 当系统打开MTD_NAND功能时，scons构建系统会加入drv_hy27uf081g驱动程序。

## 运行结果 ##

使用GNU GCC或Keil MDK编译，下载到RB4088开发板后，我们可以把方口的USB线接到RB4088板子上接标记有UART0/ISP的端口上，电脑上会有一个串口设备出来，使用PuTTY可以看到运行的结果：

     \ | /
    - RT -     Thread Operating System
     / | \     2.1.0 build Nov 15 2015
     2006 - 2015 Copyright by rt-thread team
    NAND ID: 0xFFFF
    NAND ID: 0xADF1
    finsh>>

其中NAND ID: 0xADF1是HY27UF081G的ID，前一个是原来为GD SPI NAND Flash准备的，由于新的LPC4088核心板不再保留SPI NAND Flash，所以读不到ID。

## 代码说明 ##

驱动drv_hy27uf081g实现了MTD_NAND设备的接口，即：

    struct rt_mtd_nand_driver_ops
    {
        rt_err_t (*read_id) (struct rt_mtd_nand_device* device);

        rt_err_t (*read_page)(struct rt_mtd_nand_device* device,
                              rt_off_t page,
                              rt_uint8_t* data, rt_uint32_t data_len,
                              rt_uint8_t * spare, rt_uint32_t spare_len);

        rt_err_t (*write_page)(struct rt_mtd_nand_device * device,
                               rt_off_t page,
                               const rt_uint8_t * data, rt_uint32_t data_len,
                               const rt_uint8_t * spare, rt_uint32_t spare_len);
        rt_err_t (*move_page) (struct rt_mtd_nand_device *device, rt_off_t src_page, rt_off_t dst_page);

        rt_err_t (*erase_block)(struct rt_mtd_nand_device* device, rt_uint32_t block);
        rt_err_t (*check_block)(struct rt_mtd_nand_device* device, rt_uint32_t block);
        rt_err_t (*mark_badblock)(struct rt_mtd_nand_device* device, rt_uint32_t block);
    };

并注册到系统中以一个MTD_NAND设备类型而存在。对于一个MTD_NAND类型设备，系统驱动框架中也
提供了额外的MTD_NAND API来访问，同时当打开`RT_MTD_NAND_DEBUG`选项时，驱动框架也提供了几
个命令用于查看NAND Flash上的数据情况，例如：

    nand_id          -- read ID - nandid(name)
    nand_read        -- read page in nand - nand_read(name, block, page)
    nand_readoob     -- read spare data in nand - nand_readoob(name, block, page)
    nand_write       -- write dump data to nand - nand_write(name, block, page)
    nand_erase       -- nand_erase(name, block)
    nand_erase_all   -- erase all of nand device - nand_erase_all(name)

HY27UF081G是以"nand0"设备注册到系统中的，所以调用nand_id("nand0")会显示相应的ID：

    finsh>>nand_id("nand0")
    NAND ID: 0xADF1
            0, 0x00000000

同样的，也可以使用nand_read("nand0", 0, 0)读取到第0个块的第0页：

    finsh>>nand_read("nand0", 0, 0)
    read page, rc=0
    000000: eb fe 90 4d 53 44 4f 53 35 2e 30 00 08 01 01 00  ...MSDOS5.0.....
    000010: 01 00 02 cc cc f0 37 00 3f 00 ff 00 00 00 00 00  ......7.?.......
    000020: 00 00 00 00 80 00 29 00 00 00 00 4e 4f 20 4e 41  ......)....NO NA
    000030: 4d 45 20 20 20 20 46 41 54 20 20 20 20 20 00 00  ME    FAT     ..
    000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0000f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000140: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000160: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000170: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0001a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0001b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0001c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0001d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0001e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0001f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 aa  ..............U.
    000200: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000210: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000220: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000230: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000240: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000250: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000260: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000270: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000280: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000290: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0002a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0002b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0002c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0002d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0002e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0002f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000300: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000310: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000320: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000330: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000340: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000350: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000360: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000370: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000380: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000390: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0003a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0003b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0003c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0003d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0003e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0003f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000400: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000410: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000420: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000430: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000440: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000450: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000460: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000470: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000480: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000490: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0004a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0004b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0004c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0004d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0004e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0004f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000500: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000510: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000520: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000530: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000540: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000550: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000560: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000570: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000580: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000590: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0005a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0005b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0005c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0005d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0005e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0005f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000600: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000610: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000620: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000630: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000640: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000650: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000660: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000670: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000680: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000690: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0006a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0006b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0006c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0006d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0006e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0006f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000700: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000710: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000720: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000730: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000740: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000750: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000760: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000770: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000780: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000790: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0007a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0007b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0007c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0007d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0007e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    0007f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000000: fc 3c 03 ff ff ff ff ff ff ff ff ff ff ff ff ff  .<..............
    000010: ff ff ff ff ff ff ff ff 5a a5 55 00 01 00 00 00  ........Z.U.....
    000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
            0, 0x00000000
